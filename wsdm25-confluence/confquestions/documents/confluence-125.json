{
    "id": "confluence-125",
    "title": "QEMU Upstream 1.4",
    "url": "https://openxt.atlassian.net/wiki/spaces/DC/pages/14844085/QEMU+Upstream+1.4",
    "content": "<p>Owned by Ross Philipson\nLast updated: Sep 25, 2015 by Ross Philipson\n\n</p><p><span><ac:structured-macro ac:macro-id=\"eccc4c48-6d45-48ac-90a7-798102e01c27\" ac:name=\"toc\" ac:schema-version=\"1\"></ac:structured-macro><br/></span></p><p><span>This page contains updates for QEMU upstream (1.4) in OpenXT.</span></p><h1><span>Abstract</span></h1><p>Here are the patches for QEMU 1.4. The aim is to port the patches from IOEMU (the old version of QEMU used in XEN) to a newer version of QEMU (easier to maintain and more reliable).</p><p>Even if there are already good progress, there is still one very missing patch : surfman.</p><h1><span>Building</span></h1><p>For those of you who just want to get a build rolling, or maybe kick one off while you peruse this fine document, do the following:</p><p>First clone the build scripts from openxt.git and add a line to the setup_build script to clone the meta-qemu-1.4 layer from Brendan's Github page. This line should be placed around other invocations of the 'getgit' function. In this example we add it after <a href=\"https://github.com/OpenXT/openxt/blob/master/setup_build#L115\">line 115 where the meta-selinux layer is cloned</a>:</p><pre>...\ngetgit $REPOS/meta-selinux $META_SELINUX_REPO $META_SELINUX_TAG\ngetgit $REPOS/meta-qemu-1.4 git://github.com/brendank310/meta-qemu-1.4-oxt.git master\n \n if [ ! -z \"$EXTRA_DIR\" ]; then\n...\n</pre><p>Second, enable this layer by adding it to the BBLAYERS variable in the <a href=\"https://github.com/OpenXT/openxt/blob/master/build/conf/bblayers.conf#L14\">bblayers.conf file around line 114</a>:</p><pre>...\n${TOPDIR}/repos/meta-selinux \\\n${TOPDIR}/repos/meta-qemu-1.4 \\\n\"\n...\n</pre><p>See the original instructions that went to the mailing list <a href=\"https://groups.google.com/d/msg/openxt/YFygyz6lz0c/npaGlVR544kJ\">here</a>.</p><h1><span>What's new in QEMU1.4</span></h1><ul><li>Inter-hda emulation</li><li>64 bits support for PCI Bar (some patches was submitted in QEMU/Xen mailing)</li><li>MemoryRegion API: offer a usefull way to manage MMIO and PCI Bar</li><li><strong>PCI-PASSTHROUGH</strong>:<ul><li>don't need a patch to enable it. There is now an option</li><li>use a -device xen-pci-pt,hostaddr=xxxx:yy:zz.f to provide a device</li></ul></li></ul><h1><span>Dependances</span></h1><p><span><strong>NOTE: This section might be obsolete</strong></span></p><h2><span>Packages</span></h2><ul><li>xenclient-oe (branch qemu-dm)</li><li>dm-agent (branch qemu-dm (use option -q))<ul><li>src/dm-agent</li><li>scripts/qemu-wrapper</li></ul></li></ul><h1><span>List of patches</span></h1><h2><span>static-fix</span></h2><p>QEMU with <strong>--enable-xen</strong> doesn't allow static compilation. We use static compilation for the stubdomain.</p><h2><span>ioreq-server-upstream</span></h2><h2><span>ioreq-server</span></h2><h2><span>logging-syslog</span></h2><p>Enable QEMU to log in syslog.</p><h2><span>dmbus</span></h2><p>Add wrapper for dmbus connection. It will be use for input event.</p><h2><span>surfman</span></h2><p>This patch was used to setup the XenGFX mode. Which is no longer used in XT.</p><ul><li><strong>TODO</strong>:<ul><li>Erase this patch</li><li>implements some hooks to send the surface to surfman</li></ul></li></ul><h2><span>switcher</span></h2><p>Handle input keyboard and mouse.</p><h2><span>acpi</span></h2><ul><li>Support of ACPI state;</li><li>Enable ACPI by default otherwise Windows will BSOD (In recent Xen's versions this part is made in hvmloader. See comment below)</li><li>Send state to the Input Server</li></ul><p><span><strong><em>Comments</em><span>: acpi.c: from Xen4.2, we may need remove this line from this patch:</span></strong></span></p><pre>  apm_ctrl_changed(ACPI_ENABLE, s);\n</pre><p><strong>Warning:</strong></p><ul><li><em>Hibernation</em>: Win7 doesn't leave the hibernation state properly. The RTL8139 driver for Window7 is no longer supported and let the guest in a bad status. Use e1000 netwotk device instead of rtl8139 to avoid any issue (see VM configuration).</li></ul><h2><span>xc-emulated-nic-link-state-propagation</span></h2><p>Propagate network link status to the guest. This patch:</p><ul><li>add a support to be notify when network is up/down via XenStore;</li><li>modify rt8189 card (use by default in XT) to handle link state.</li></ul><h2><span>Battery</span></h2><p>Re-write the old patch from <em>Kamala Narasimhan</em>:</p><ul><li>use memory_region to add new IOPORT</li><li>depends of hvmloader/acpi/ssdt.asl</li></ul><p><span>Missing features:</span></p><ul><li>It doesn't implement the GPE yet.</li><li>The patch implements the multiple batteries management, it doesn't allow to hotplug a battery</li></ul><h2><span>audio-alsa</span></h2><ul><li>enable volume controle</li></ul><h2><span>xenmou</span></h2><ul><li>Mouse emulation via a PCI device.</li></ul><h2><span>ATAPI-PASSTHROUGH</span></h2><p>This is a re-implementation of the original ATAPI-Passthrough patch for IOEMU. Even if the logic has been kept (directly forward the SYSCall to the disk drive), the design has been changed.</p><p>Now there are 2 parts:</p><ul><li>the device emulation</li><li>the device drivers<ul><li>directly execute the IOCTL</li><li>one for the stubdom (It implements IOCTL over v4v)</li></ul></li></ul><p><span><strong>Command line</strong><span> </span></span></p><pre>  -drive file=/dev/bsg/1:0:0:0,media=cdrom,if=atapi-pt,format=pt</pre><p><span><br/></span></p><p><span><strong><br/></strong></span></p>",
    "date": "2024-11-15",
    "disclaimer": "Users of this benchmark dataset are advised to check Atlassian’s official documentation for the most current information.",
    "space": "DC"
}