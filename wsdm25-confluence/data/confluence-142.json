{
    "id": "confluence-142",
    "title": "Jessie systemd container",
    "url": "https://openxt.atlassian.net/wiki/spaces/BS/pages/19988483/Jessie+systemd+container",
    "content": "<p>Owned by Adam Oliver\nLast updated: May 12, 2016 by Jennifer Temkin\n\n</p><p>These instructions will give you a container capable of building the jethro based OpenXT repo that was merged on February 4, 2016.    If you wish to reuse an old container you must at least update GCC to 4.9.2 and binutils to 2.25.</p><p>1) Install debootstrap on your host.  Below is an example of doing so in ArchLinux from AUR (Arch specific step). The Arch method will vary on if you use yaourt or have added the repo for use with pacman.</p><ac:structured-macro ac:macro-id=\"396efbdf-d811-4a6c-8557-efa5a72cf453\" ac:name=\"code\" ac:schema-version=\"1\"><ac:parameter ac:name=\"language\">bash</ac:parameter><ac:plain-text-body><![CDATA[yaourt debootstrap]]></ac:plain-text-body></ac:structured-macro><p>2) Download the Debian Jessie rootfs.</p><ac:structured-macro ac:macro-id=\"7668ba6e-71ee-404f-b60e-81a407919a57\" ac:name=\"code\" ac:schema-version=\"1\"><ac:parameter ac:name=\"language\">bash</ac:parameter><ac:plain-text-body><![CDATA[sudo debootstrap --arch=i386 jessie ./jessie-i386-01]]></ac:plain-text-body></ac:structured-macro><p>3) Start the container.</p><ac:structured-macro ac:macro-id=\"69f410db-3310-4842-94e9-d81fdfb5c840\" ac:name=\"code\" ac:schema-version=\"1\"><ac:parameter ac:name=\"language\">bash</ac:parameter><ac:plain-text-body><![CDATA[sudo systemd-nspawn --personality=x86 -D ./jessie-i386-01/]]></ac:plain-text-body></ac:structured-macro><p>4) Update apt.</p><ac:structured-macro ac:macro-id=\"a274c97b-b27c-4115-91b5-11f7e0fdbd17\" ac:name=\"code\" ac:schema-version=\"1\"><ac:parameter ac:name=\"language\">bash</ac:parameter><ac:plain-text-body><![CDATA[apt-get update]]></ac:plain-text-body></ac:structured-macro><p>5) Install OE dependencies.</p><ac:structured-macro ac:macro-id=\"ef265cbb-47d7-4c70-883b-7774efcc348f\" ac:name=\"code\" ac:schema-version=\"1\"><ac:parameter ac:name=\"language\">bash</ac:parameter><ac:plain-text-body><![CDATA[apt-get install gawk wget git-core diffstat unzip texinfo gcc-multilib build-essential chrpath socat libsdl1.2-dev xterm]]></ac:plain-text-body></ac:structured-macro><p>6) Install additional OpenXT dependencies.</p><ac:structured-macro ac:macro-id=\"2dfc888b-ae9b-48e1-b9b7-bfdd232edd3d\" ac:name=\"code\" ac:schema-version=\"1\"><ac:parameter ac:name=\"language\">bash</ac:parameter><ac:plain-text-body><![CDATA[apt-get install vim sed wget cvs subversion coreutils texi2html docbook-utils python-pysqlite2 help2man desktop-file-utils cpio sudo rpm curl guilt iasl quilt bin86 bcc liburi-perl genisoimage policycoreutils libncurses5-dev]]></ac:plain-text-body></ac:structured-macro><p>7) The version of GHC in Jessie is not capable of building the GHC 6.12.1 we use for OpenXT. Therefore we need to install the last version of GHC 6 (6.12.3) into the container. GHC uses GHC to compile GHC! Download the three prerequisite packages for GHC 6.12.3 and install them.</p><ul><li><p><a href=\"http://archive.debian.org/debian/pool/main/g/gmp/libgmpxx4ldbl_4.3.2+dfsg-1_i386.deb\">http://archive.debian.org/debian/pool/main/g/gmp/libgmpxx4ldbl_4.3.2+dfsg-1_i386.deb</a></p></li><li><p><a href=\"http://archive.debian.org/debian/pool/main/g/gmp/libgmp3-dev_4.3.2+dfsg-1_i386.deb\" style=\"line-height: 1.42857;\">http://archive.debian.org/debian/pool/main/g/gmp/libgmp3-dev_4.3.2+dfsg-1_i386.deb</a></p></li><li><p><a href=\"http://archive.debian.org/debian/pool/main/g/gmp/libgmp3c2_4.3.2+dfsg-1_i386.deb\" style=\"line-height: 1.42857;\">http://archive.debian.org/debian/pool/main/g/gmp/libgmp3c2_4.3.2+dfsg-1_i386.deb</a></p></li></ul><ac:structured-macro ac:macro-id=\"172ec496-8cfd-49dc-b110-3a19f3e0df4c\" ac:name=\"code\" ac:schema-version=\"1\"><ac:parameter ac:name=\"language\">bash</ac:parameter><ac:plain-text-body><![CDATA[dpkg -i libgmpxx4ldbl_4.3.2+dfsg-1_i386.deb libgmp3c2_4.3.2+dfsg-1_i386.deb libgmp3-dev_4.3.2+dfsg-1_i386.deb]]></ac:plain-text-body></ac:structured-macro><p>8) Download and install GHC 6.12.3.</p><ac:structured-macro ac:macro-id=\"1ae5a768-e16d-44a6-9ce0-81406acbeb1b\" ac:name=\"code\" ac:schema-version=\"1\"><ac:parameter ac:name=\"language\">bash</ac:parameter><ac:plain-text-body><![CDATA[cd /tmp\nwget http://www.haskell.org/ghc/dist/6.12.3/ghc-6.12.3-i386-unknown-linux-n.tar.bz2  \ntar jxf ghc-6.12.3-i386-unknown-linux-n.tar.bz2  \ncd ghc-6.12.3  \n./configure --prefix=/usr  \nmake install]]></ac:plain-text-body></ac:structured-macro><p>9) Create a build user.</p><ac:structured-macro ac:macro-id=\"8df598a0-c568-43d0-a13d-62bd010b3610\" ac:name=\"code\" ac:schema-version=\"1\"><ac:parameter ac:name=\"language\">bash</ac:parameter><ac:plain-text-body><![CDATA[adduser build]]></ac:plain-text-body></ac:structured-macro><p>10) Set the default shell to bash. (Answer no to letting dash be the shell)</p><ac:structured-macro ac:macro-id=\"38213c0f-a6aa-4364-8a49-730796d462e3\" ac:name=\"code\" ac:schema-version=\"1\"><ac:parameter ac:name=\"language\">bash</ac:parameter><ac:plain-text-body><![CDATA[dpkg-reconfigure dash]]></ac:plain-text-body></ac:structured-macro><p>11) If /etc/mtab does not exist, create it. Rootfs steps will fail if it is missing.</p><ac:structured-macro ac:macro-id=\"3a0d6a2f-a883-4a23-8ad2-e7da9a3b4533\" ac:name=\"code\" ac:schema-version=\"1\"><ac:parameter ac:name=\"language\">bash</ac:parameter><ac:plain-text-body><![CDATA[ln -s /proc/mounts /etc/mtab]]></ac:plain-text-body></ac:structured-macro><p>12) Skip to step 12 if not sharing any directories from outside the container or if you bound them already in step 3. If you intend to bind the directories within the build user's home directory, you need to wait until it was created in step 7 to bind. The directory will be bound to the exact same path. Exit the container and restart it, binding any existing directories to use within the container, i.e. OE download cache. Hit CTRL-[ three times to exit container and then restart it, binding the directories.</p><ac:structured-macro ac:macro-id=\"a038750a-5d35-4e91-9888-93e3b59a75de\" ac:name=\"code\" ac:schema-version=\"1\"><ac:parameter ac:name=\"language\">bash</ac:parameter><ac:plain-text-body><![CDATA[sudo systemd-nspawn --bind=/<path-to-oe-download-cache> --personality=x86 -D ./jessie-i386-01/]]></ac:plain-text-body></ac:structured-macro><p>13) Become the build user.</p><ac:structured-macro ac:macro-id=\"61824850-51b2-433f-b9ac-ae8cf3ac58f7\" ac:name=\"code\" ac:schema-version=\"1\"><ac:parameter ac:name=\"language\">bash</ac:parameter><ac:plain-text-body><![CDATA[su build\ncd ~]]></ac:plain-text-body></ac:structured-macro><p>14) Clone the OpenXT repo.</p><ac:structured-macro ac:macro-id=\"51b19a20-de22-4856-bea7-b4baedd894ce\" ac:name=\"code\" ac:schema-version=\"1\"><ac:parameter ac:name=\"language\">bash</ac:parameter><ac:plain-text-body><![CDATA[git clone https://github.com/OpenXT/openxt.git]]></ac:plain-text-body></ac:structured-macro><p>15) Create your .config file. Change any settings needed now.</p><ac:structured-macro ac:macro-id=\"8dfb6b5b-2a84-4f7b-b344-c974c3da169c\" ac:name=\"code\" ac:schema-version=\"1\"><ac:parameter ac:name=\"language\">bash</ac:parameter><ac:plain-text-body><![CDATA[cp example-config .config]]></ac:plain-text-body></ac:structured-macro><p>16) Generate your signing certs per <a href=\"https://github.com/OpenXT/openxt/wiki/Building-OpenEmbedded\" style=\"line-height: 1.42857;\">https://github.com/OpenXT/openxt/wiki/Building-OpenEmbedded</a>. Remember, you can use the bind parameter for systemd-nspawn to reuse an existing set of certs that are outside the container. Make sure to add the certificate locations to .config.</p><p>17) Run the setupoe step.</p><ac:structured-macro ac:macro-id=\"ee756644-d543-4b74-a4f1-2c0f3a8f856d\" ac:name=\"code\" ac:schema-version=\"1\"><ac:parameter ac:name=\"language\">bash</ac:parameter><ac:plain-text-body><![CDATA[do_build.sh -s setupoe]]></ac:plain-text-body></ac:structured-macro><p>18) If you are sharing an OE download cache directory, make sure to set it in build/conf/local.conf.</p><ac:structured-macro ac:macro-id=\"3b6f75cb-2180-432c-abc0-1578d5f6a185\" ac:name=\"code\" ac:schema-version=\"1\"><ac:parameter ac:name=\"language\">bash</ac:parameter><ac:plain-text-body><![CDATA[DL_DIR = \"/<path-to-OE-download-cache>\"]]></ac:plain-text-body></ac:structured-macro><p>19) Build OpenXT.</p><h3>Build Notes</h3><p>When running do_build.sh, either change the list of steps at the beginning of the script to what you need or specify them manually via -s. An example is below.</p><ac:structured-macro ac:macro-id=\"414fef75-ca06-4440-a864-5f444065f525\" ac:name=\"code\" ac:schema-version=\"1\"><ac:parameter ac:name=\"language\">bash</ac:parameter><ac:plain-text-body><![CDATA[./do_build.sh -s initramfs,stubinitramfs,dom0]]></ac:plain-text-body></ac:structured-macro><p>To build or clean individual recipes you can use the bb wrapper script. An example is below.</p><ac:structured-macro ac:macro-id=\"19ea3d9a-832c-4c4a-9db3-9ca2a8fe1ae3\" ac:name=\"code\" ac:schema-version=\"1\"><ac:parameter ac:name=\"language\">bash</ac:parameter><ac:plain-text-body><![CDATA[cd build\nDISTRO=\"openxt-main\" MACHINE=\"<machine type>\" ./bb -c cleansstate <recipe-name>]]></ac:plain-text-body></ac:structured-macro><p>If you build a recipe, such as dom0, in this way you will need to run that recipe's copy step in the do_build.sh script before rerunning the ship step (generates iso). Look at the do_build.sh script to see which steps also have a copy step.</p><ac:structured-macro ac:macro-id=\"06bd1e16-153f-439b-86e4-0a1a8b09f9ed\" ac:name=\"code\" ac:schema-version=\"1\"><ac:parameter ac:name=\"language\">bash</ac:parameter><ac:plain-text-body><![CDATA[DISTRO=\"openxt-main\" MACHINE=\"xenclient-dom0\" ./bb xenclient-dom0-image\ncd ..  \n./do_build.sh -s dom0cp,ship]]></ac:plain-text-body></ac:structured-macro><p> </p><p> </p><pre> </pre>",
    "date": "2024-11-15",
    "disclaimer": "Users of this benchmark dataset are advised to check Atlassian’s official documentation for the most current information.",
    "space": "BS"
}